<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M3U8 Player with Quality & Subtitles</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">

<style>
* { margin:0; padding:0; box-sizing:border-box; }
html,body { background:#000; height:100vh; width:100vw; overflow:hidden; font-family:system-ui,sans-serif; }
.shaka-video-container { position:absolute; inset:0; width:100%; height:100%; }
video { width:100%; height:100%; object-fit:contain; background:#000; }
.youtube-theme { font-family:'Roboto',sans-serif; }
.youtube-theme .shaka-controls-button-panel > * { color:#EEE; height:40px; margin:0; padding:3px 8px; }
.youtube-theme .shaka-seek-bar-container input[type=range]::-webkit-slider-thumb { background:#FF0000; cursor:pointer; }
.youtube-theme .shaka-seek-bar-container input[type=range]::-moz-range-thumb { background:#FF0000; cursor:pointer; }
.youtube-theme .shaka-seek-bar-container input[type=range]::-ms-thumb { background:#FF0000; cursor:pointer; }
.manual-play-button { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.8); color:white; padding:20px 30px; border-radius:8px;
  cursor:pointer; font-size:18px; z-index:2000; border:2px solid #ff0000; display:none; transition:all 0.3s ease;
}
.manual-play-button:hover { background:rgba(255,0,0,0.8); transform:translate(-50%,-50%) scale(1.05); }
</style>
</head>
<body>

<div class="shaka-video-container youtube-theme" data-shaka-player>
  <video autoplay muted playsinline preload="auto"></video>
  <div class="manual-play-button" id="manualPlayButton">â–¶ Click to Play</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
<script>
const queryParams = new URLSearchParams(window.location.search);
const m3u8Url = queryParams.get('url'); // M3U8 URL

document.addEventListener('DOMContentLoaded', async () => {
  shaka.polyfill.installAll();
  if (!shaka.Player.isBrowserSupported()) { console.error('Browser not supported'); return; }

  const video = document.querySelector('video');
  const container = document.querySelector('.shaka-video-container');
  const player = new shaka.Player();
  await player.attach(video);

  const ui = new shaka.ui.Overlay(player, container, video);
  ui.configure({
    controlPanelElements: [
      'play_pause','time_and_duration','mute','volume','spacer',
      'captions','quality','language','picture_in_picture','fullscreen','overflow_menu'
    ]
  });

  // Enable automatic ABR & show all available tracks
  player.configure({
    streaming: {
      rebufferingGoal: 2,
      bufferingGoal: 15,
      bufferBehind: 15,
      lowLatencyMode: true
    }
  });

  // Load M3U8 stream
  try {
    await player.load(m3u8Url);
    console.log('M3U8 Loaded:', m3u8Url);
  } catch(e) { console.error('Failed to load M3U8:', e); }

  // Autoplay handling
  const attemptAutoplay = async () => {
    try { video.muted=false; await video.play(); return true; }
    catch { try { video.muted=true; await video.play(); return true; } catch(e) { return false; } }
  };
  await attemptAutoplay();

  // User interaction for sound
  let hasUserInteracted=false;
  const enableSound=()=>{ if(!hasUserInteracted && video.muted){ video.muted=false; hasUserInteracted=true; } };
  ['click','touchstart','keydown'].forEach(e => document.addEventListener(e, enableSound, {once:true}));

  // Autoplay resume on visibility change
  document.addEventListener('visibilitychange', () => { if(!document.hidden && video.paused){ attemptAutoplay(); } });

  // Subtitles toggle example
  const textTracks = video.textTracks;
  if(textTracks && textTracks.length > 0){
    textTracks[0].mode = 'showing'; // default first track
  }

  // Optional: dynamically list available quality tracks in console
  const variants = player.getVariantTracks();
  console.log('Available qualities:', variants.map(v=>({height:v.height,width:v.width,bitrate:v.bandwidth})));
});
</script>

</body>
</html>
